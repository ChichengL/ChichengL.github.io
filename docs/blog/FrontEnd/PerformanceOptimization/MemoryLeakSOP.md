## 内存泄漏定义

- `内存泄漏` = `垃圾` 没被回收
  - 垃圾的定义是业务上不需要用到的就是垃圾
    - 推论： 这个判断一定是从业务来的
    - 一个 10000 个元素的缓存池，达到或超出容量后直接丢弃至容量的一半，连续每次添加 2000 个元素
      - 第 1 次添加 / 第 5 次添加 / 第 6+ 次添加，内存曲线也不可能回去，
      - 但它是符合预期的缓存

### 一定是垃圾 Garbage 的东西：

- 在 JS 代码执行层面，从顶层到底层都一定无法被 JS 代码再访问到的就是垃圾 (不可达性)
  - 大部分会被垃圾回收，但不一定都能被引擎回收会被回收
  - 「从代码层面引用不可达，但是从引擎层面还是认为“引用可达”」
    - 不可达但不能被回收的部分就是 内存泄漏 ，之一

### 内存泄漏的来源有且只有

1. 不需要使用的内容的引用 被本身不会销毁的外层甚至是顶层(执行上下文)持有
   1. 业务侧的不需要的 直接引用 被非预期的泄漏到本身不会销毁的外层
   2. 三方包中 不需要的 直接引用 被非预期的泄漏到本身不会销毁的外层
   3. 同级闭包的词法环境共享，隐式间接引用 持有
2. 引擎 Bug，如 Chrome Bug / V8 Bug

#### 闭包词法环境共享导致泄漏

在 V8 遇到内部函数闭包时，会为整个包含它们的作用域创建一个 共有的 Context（词法环境）。
所有闭包都引用这个共有的 Context，无论它们是否真的使用上下文中的某些变量。
如果作用域里某个变量被任意一个闭包引用，即使其它闭包不需要访问它，也会被一起放到 Context 里，导致被使用函数已经回收了，但函数内的闭包数据还是共用的 Context 里，
因此只要有一个函数还在使用，Context 就无法回收；
![](https://s21.ax1x.com/2025/08/08/pVatOE9.png)

## 排查 SOP

### 前期环境准备

- 固定基准 commit
  比如： 一个确定存在内存泄漏的 commit
- 确定复现路径
  - 要求为，「页面上路径从 基准状态 经过操作后，最后回到 基准状态 」为一次复现循环，多次执行循环看到快照内存持续增长不收敛 为复现链路
- 始终使用线上构建环境排查，但去掉 变量名、方法名、类名 等 名称缩写压缩，保留其他所有压缩方式，保证除包体积外，完全模拟线上场景；构建发布泳道
  不要使用开发环境，同时最好尽可能关闭浏览器插件。
  - 为什么要关 React Developer Tools
  - 所有的 react render root ，也就是 reconciler 都会注册到 devtools
  - 具体来说就是 react-dom 会自动 injectIntoDevTools ，再往内部就是往 **REACT_DEVTOOLS_GLOBAL_HOOK** 上挂，所有的 react fiber 会被它引用

### 排查流程

1. 以上准备好的前提下，在开始前基准状态下 开启 Devtools Memory，打出 Heap snapshot，重复操作结束后再打 Heap snapshot 对比
2. 通过两次 Heap snapshot compare ，比较找出新增、且无法从根上达到访问的对象 (通常为闭包上下文 context 引用)
3. 分析最明显的增长对象的被引用链路
   - 要求为：对于从 该对象 到 根顶层(Window) 的整条引用链路，需要看懂明确所有引用父级是谁、怎么被引用的
   - 记录分析过程到文档，用于后续复盘及信息同步
4. 根据业务上下文及对应代码，识别不合理引用链路，解除引用代码；推送、重新构建、部署
   1. 作为 SOP 流程，一次只分析最典型的那个、只修复最典型的是可以的，也是最简单可操作无门槛的
5. 重复执行这个排查过程，直到该操作链路没有明显问题，即多次 基准状态 后内存恒定

## 如何分析

### 认识 Devtool Memory

- 左边是什么，Comparison 是什么，右边上面是什么，右边下面是什么
  - 从上到下表示它被谁引用到，distance , Shallow Size , Retained Size
  - reachable, Detached
    ![](https://s21.ax1x.com/2025/08/08/pVatx9x.png)

### 核心步骤

上面说到排查的过程就是搞清楚 对于从 该泄漏对象 到 根顶层(Window) 的整条引用链路，需要看懂明确所有引用父级是谁、怎么被引用的

知道怎么被引用的，也就能根据业务判断识别哪些是 不合理 引用链路，以此来改造解除引用代码

要说核心，实际操作也就是 逐行读引用，确认他们是什么 就完了
